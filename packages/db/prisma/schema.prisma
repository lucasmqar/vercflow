generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// Roles for User (String-based for SQLite)
// ADMIN, CEO, GESTOR, TRIAGISTA, OPERACIONAL, PROFISSIONAL_INTERNO, PROFISSIONAL_EXTERNO, CLIENTE_VIEW

model User {
  id              String           @id @default(cuid())
  nome            String
  email           String           @unique
  senhaHash       String
  role            String           @default("OPERACIONAL")
  ativo           Boolean          @default(true)
  criadoEm        DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  logs            AuditLog[]
  records         Record[]
  professional    Professional?
  raciAssignments RaciAssignment[]
  comments        Comment[]
  requestsCreated Request[]        @relation("UserRequestsCreated")
  requestsManaged Request[]        @relation("UserRequestsManaged")
  recordsAsResponsavel Record[]     @relation("ResponsavelValores")
  
  // Vercflow specific roles
  obrasAsMestre     Project[] @relation("MestreObra")
  obrasAsEngenheiro Project[] @relation("EngenheiroResponsavel")
  vehicles          Vehicle[] @relation("VehicleResponsable")
  stockMovements    StockMovement[] @relation("UserStockMovements")
  
  // Fase 1: DP & DST
  employee          Employee?
  safetyInspections SafetyInspection[] @relation("InspectorSafety")
  toolLoans         ToolLoan[]
}

model Client {
  id                String    @id @default(cuid())
  nome              String
  tipo              String    @default("PF") // PF, PJ
  documento         String?   // CPF ou CNPJ
  rgIe              String?   // RG ou Inscrição Estadual
  contatos          String?   // JSON {telefone, whatsapp, email}
  enderecoCompleto  String?
  representacao     String?   // JSON for procurations {equatorial: {validade, anexoUrl}, saneago: {...}}
  configOrgaos      String?   // JSON {prefeitura: boolean, condomínio: boolean, suderv: boolean, etc}
  criadoEm          DateTime  @default(now())
  projects          Project[]
  leads             Lead[]    // Fase 2: Pipeline Comercial
}

model Project {
  id                    String        @id @default(cuid())
  codigoInterno         String?       @unique
  nome                  String
  endereco              String?
  tipoObra              String?       // RESIDENCIAL, COMERCIAL, INDUSTRIAL, SAUDE, etc
  dadosLote             String?       // JSON {quadra, lote, matricula, areaLote, cno}
  areaConstruida        Float?
  pavimentos            Int?
  exigenciasAprovacao   String?       // JSON {prefeitura, condomínio, cbm, visa, etc}
  status                String        @default("ORCAMENTO") // ORCAMENTO, NEGOCIACAO, FECHADA, ATIVA, CONCLUIDA, EM_PAUSA, CANCELADA
  categoria             String?       // COMERCIAL, INDUSTRIAL, RESIDENCIAL, HOSPITALAR, CONDOMINIO, EDIFICIO
  criadoEm              DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  
  clientId              String
  client                Client        @relation(fields: [clientId], references: [id])
  
  mestreObraId          String?
  mestreObra            User?         @relation("MestreObra", fields: [mestreObraId], references: [id])
  
  engenheiroId          String?
  engenheiroResponsavel User?         @relation("EngenheiroResponsavel", fields: [engenheiroId], references: [id])
  
  
  activities            Activity[]
  records               Record[]
  disciplines           Discipline[]
  requests              Request[]
  checklistItems        ChecklistItem[]
  purchaseRequests      PurchaseRequest[]
  files                 ProjectFile[]
  fees                  Fee[]
  stockMovements        StockMovement[]
  
  // Fase 1: DP & DST
  accidents             Accident[]
  safetyInspections     SafetyInspection[]
  toolLoans             ToolLoan[]
  
  // Fase 2: Comercial
  proposal              Proposal?
}

model Fee {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  documentId  String?
  document    Document? @relation(fields: [documentId], references: [id])
  nome        String
  valor       Float
  vencimento  DateTime?
  status      String   @default("PENDENTE") // PENDENTE, PAGO, CANCELADO
  anexoUrl    String?
  criadoEm    DateTime @default(now())
}

model Request {
  id                 String        @id @default(cuid())
  projectId          String
  project            Project       @relation(fields: [projectId], references: [id])
  title              String
  description        String
  type               String
  status             String        @default("open")
  priority           String        @default("MEDIA")
  requestedById      String
  requestedBy        User          @relation("UserRequestsCreated", fields: [requestedById], references: [id])
  assignedToId       String?
  assignedTo         Professional? @relation(fields: [assignedToId], references: [id])
  dueDate            DateTime?
  cancellationReason String?
  cancelledById      String?
  cancelledBy        User?         @relation("UserRequestsManaged", fields: [cancelledById], references: [id])
  cancelledAt        DateTime?
  criadoEm           DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
}

model Discipline {
  id            String           @id @default(cuid())
  projectId     String
  project       Project          @relation(fields: [projectId], references: [id])
  codigo        String           // 1.x a 14.x conforme lista oficial
  name          String
  category      String
  status        String           @default("NAO_CONTRATADO") // NAO_CONTRATADO, EM_DESENVOLVIMENTO, ENVIADO, APROVADO, REPROVADO
  fase          String?          // PRELIMINAR, LEGAL, EXECUTIVO, CONDOMINIO (para ARQUITETURA 2.x)
  responsibleId String?
  responsible   Professional?    @relation(fields: [responsibleId], references: [id])
  activities    Activity[]
  previsao      DateTime?
  entregaReal   DateTime?
  versaoAtual   String?
  checklistItems ChecklistItem[]
  
  criadoEm      DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@unique([projectId, codigo, fase])
}

model ChecklistItem {
  id             String      @id @default(cuid())
  projectId      String
  project        Project     @relation(fields: [projectId], references: [id])
  disciplineId   String?
  discipline     Discipline? @relation(fields: [disciplineId], references: [id])
  
  tipo           String      // DOCUMENTO_FASE, PROJETO_FASE, MATERIAL_AMBIENTE
  codigo         String?     // Ex: 2.3, 14.4
  descricao      String
  ambiente       String?     // Para itens 14.x
  departamento   String?
  responsavelId  String?
  prazo          DateTime?
  status         String      @default("PENDENTE") // PENDENTE, EM_ANDAMENTO, ENVIADO, APROVADO, REPROVADO, COMPRADO, ENTREGUE, INSTALADO
  
  // Campos de compra (para Materiais)
  quantidade     Float?
  marca          String?
  nf             String?
  fornecedor     String?
  
  anexoUrl       String?
  revisao        Int         @default(0)
  
  criadoEm       DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
}

model PurchaseRequest {
  id              String             @id @default(cuid())
  projectId       String
  project         Project            @relation(fields: [projectId], references: [id])
  solicitanteId   String
  disciplina      String?
  status          String             @default("SOLICITADO") // SOLICITADO, EM_COTACAO, AGUARDANDO_APROVACAO, OC_EMITIDA, EM_ENTREGA, CONFERIDO, FINALIZADO
  urgencia        String             @default("NORMAL")
  obs             String?
  cotacoes        PurchaseQuotation[]
  ordemCompra     PurchaseOrder?
  criadoEm        DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

model PurchaseQuotation {
  id                String          @id @default(cuid())
  requestId         String
  request           PurchaseRequest @relation(fields: [requestId], references: [id])
  fornecedor        String
  valorTotal        Float
  prazoEntrega      String?
  condicaoPagamento String?
  anexoUrl          String?
  selecionada       Boolean         @default(false)
  criadoEm          DateTime        @default(now())
}

model PurchaseOrder {
  id                String          @id @default(cuid())
  requestId         String          @unique
  request           PurchaseRequest @relation(fields: [requestId], references: [id])
  numeroOC          String          @unique
  valorFinal        Float
  dataEmissao       DateTime        @default(now())
  status            String          @default("EMITIDA")
  nf                String?
  documentoNfUrl    String?
  criadoEm          DateTime        @default(now())
}

model ProjectFile {
  id            String   @id @default(cuid())
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id])
  disciplineId  String?  // Vincula a uma disciplina específica
  nome          String   // Nome padronizado: João Silva – ARQ – EXE – R0 – F01.pdf
  tipo          String?  // ALV, ORC, CPR, CRO, PED, REL, MEM, OUT, ARQ, EST, HID, ELE, etc
  fase          String?  // PRE, LEG, EXE, CON
  revisao       String   @default("R0")
  folha         String?
  url           String
  extensao      String
  origem        String?  // CONSTRUTORA, RECEBIDO, TERCEIRO
  faseObra      String?  // ORCAMENTO, EXECUCAO, CONCLUIDA
  tags          String?  // JSON array de tags personalizadas
  criadoEm      DateTime @default(now())
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  tipoEvento  String
  entidade    String
  entidadeId  String
  payloadJson String?
  criadoEm    DateTime @default(now())
}

model Record {
  id                    String       @id @default(cuid())
  refCodigo             String       @unique @default(cuid())
  authorId              String
  projectId             String?
  clientId              String?
  texto                 String?      // Legacy compatibility
  type                 String       @default("TEXTO") // TEXTO, FOTO, ESBOCO, CHECKLIST
  status               String       @default("REGISTRO") // REGISTRO, TRIAGEM, CLASSIFICACAO, ORDENACAO, VALIDACAO, DISTRIBUICAO, CONVERTIDO, ARQUIVADO
  prioridade           String       @default("MEDIA")
  natureza             String?      // Ex: ORCAMENTO, TECNICO, FINANCEIRO
  responsavelValoresId String?
  responsavelValores   User?        @relation("ResponsavelValores", fields: [responsavelValoresId], references: [id])
  parentId             String?
  parent               Record?      @relation("RecordRevisions", fields: [parentId], references: [id])
  revisions            Record[]     @relation("RecordRevisions")
  isInicial            Boolean      @default(true)
  criadoEm              DateTime     @default(now())
  project               Project?     @relation(fields: [projectId], references: [id])
  author                User         @relation(fields: [authorId], references: [id])
  items                 RecordItem[]
  activities            Activity[]
  documents             Document[]
  sketch                Sketch?
}

model RecordItem {
  id        String     @id @default(cuid())
  recordId  String
  record    Record     @relation(fields: [recordId], references: [id])
  type      String     @default("TEXTO") // TEXTO, FOTO, ESBOCO, CHECKLIST
  checked   Boolean   @default(false)
  content   String     // Text, JSON do esboço, URL da imagem ou JSON do checklist
  order     Int        @default(0)
  criadoEm  DateTime   @default(now())
}

model Sketch {
  id       String   @id @default(cuid())
  recordId String   @unique
  record   Record   @relation(fields: [recordId], references: [id])
  dataJson String
  imageUrl String?
  criadoEm DateTime @default(now())
}

model Document {
  id       String   @id @default(cuid())
  recordId String
  record   Record   @relation(fields: [recordId], references: [id])
  tipo     String   @default("ESBOCO_TIMBRADO")
  pdfUrl   String?
  status   String   @default("RASCUNHO")
  versao   Int      @default(1)
  hash     String?
  fees     Fee[]
  criadoEm DateTime @default(now())
}

model Activity {
  id          String               @id @default(cuid())
  recordId    String?
  record      Record?              @relation(fields: [recordId], references: [id])
  projectId   String
  project     Project              @relation(fields: [projectId], references: [id])
  titulo      String
  descricao   String?
  status      String               @default("PLANEJADO") // PLANEJADO, EM_EXECUCAO, CONCLUIDO, BLOQUEADO, CANCELADO
  prioridade  String               @default("MEDIA")
  dataInicio  DateTime?
  dataFim     DateTime?
  criadoEm    DateTime             @default(now())
  disciplineId String?
  discipline  Discipline?          @relation(fields: [disciplineId], references: [id])
  assignments ActivityAssignment[]
}

model Professional {
  id              String               @id @default(cuid())
  nome            String
  tipo            String               @default("EXTERNO_MAO_OBRA") 
  documento       String?
  contatos        String?
  userId          String?              @unique
  user            User?                @relation(fields: [userId], references: [id])
  assignments     ActivityAssignment[]
  disciplines     Discipline[]
  requestsManaged Request[]
  categories      ProfessionalCategory[]
  criadoEm        DateTime               @default(now())
}

model ProfessionalCategory {
  id             String       @id @default(cuid())
  professionalId String
  professional   Professional @relation(fields: [professionalId], references: [id])
  category       String       // Ex: levantamento, eletrico, etc (from reference)
  criadoEm       DateTime     @default(now())

  @@unique([professionalId, category])
}

model ActivityAssignment {
  id             String       @id @default(cuid())
  activityId     String
  activity       Activity     @relation(fields: [activityId], references: [id])
  professionalId String
  professional   Professional @relation(fields: [professionalId], references: [id])
  valorPrevisto  Float
  valorReal      Float?
  criadoEm       DateTime     @default(now())
}

model RaciAssignment {
  id         String     @id @default(cuid())
  entityType String
  entityId   String
  userId     String
  user       User       @relation(fields: [userId], references: [id])
  role       String     // RESPONSIBLE, ACCOUNTABLE, CONSULTED, INFORMED
  criadoEm   DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

model Comment {
  id         String     @id @default(cuid())
  entityType String
  entityId   String
  userId     String
  user       User       @relation(fields: [userId], references: [id])
  content    String
  criadoEm   DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}
model StockMovement {
  id            String   @id @default(cuid())
  tipo          String   // ENTRADA, SAIDA, TRANSFERENCIA
  item          String
  quantidade    Float
  unidade       String?
  obraId        String?
  obra          Project? @relation(fields: [obraId], references: [id])
  usuarioId     String
  usuario       User     @relation("UserStockMovements", fields: [usuarioId], references: [id])
  observacao    String?
  criadoEm      DateTime @default(now())
}

model Vehicle {
  id            String   @id @default(cuid())
  placa         String   @unique
  modelo        String
  marca         String
  tipo          String   // CAMINHAO, CARRO, MOTO, UTILITARIO
  cor           String?
  ano           Int?
  responsavelId String?
  responsavel   User?    @relation("VehicleResponsable", fields: [responsavelId], references: [id])
  status        String   @default("DISPONIVEL") // DISPONIVEL, EM_USO, MANUTENCAO
  quilometragem Int      @default(0)
  criadoEm      DateTime @default(now())
  maintenances  MaintenanceRecord[]
}

// ========== FASE 1: DP (DEPARTAMENTO PESSOAL) ==========

model Employee {
  id              String    @id @default(cuid())
  userId          String?   @unique
  user            User?     @relation(fields: [userId], references: [id])
  nome            String
  cpf             String    @unique
  rg              String?
  dataNascimento  DateTime?
  endereco        String?
  contatos        String?   // JSON {telefone, email, emergencia}
  cargo           String
  departamento    String
  salario         Float
  dataAdmissao    DateTime
  dataDemissao    DateTime?
  statusAtual     String    @default("ATIVO") // ATIVO, FERIAS, AFASTADO, DEMITIDO
  motivoDemissao  String?
  observacoes     String?
  criadoEm        DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  payrolls         Payroll[]
  benefits         EmployeeBenefit[]
  asos             ASO[]
  accidents        Accident[]
  epiDistributions EPIDistribution[]
  exitInterview    ExitInterview?
}

model Payroll {
  id              String    @id @default(cuid())
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id])
  mesReferencia   DateTime
  salarioBase     Float
  horasExtras     Float?
  bonificacoes    Float?
  descontos       Float?
  salarioLiquido  Float
  dataPagamento   DateTime?
  status          String    @default("PENDENTE") // PENDENTE, PAGO, CANCELADO
  observacoes     String?
  criadoEm        DateTime  @default(now())
  
  @@unique([employeeId, mesReferencia])
}

model Benefit {
  id              String            @id @default(cuid())
  nome            String
  tipo            String            // VALE_TRANSPORTE, ALIMENTACAO, SAUDE, DENTAL, etc
  valor           Float?
  descricao       String?
  criadoEm        DateTime          @default(now())
  
  employees       EmployeeBenefit[]
}

model EmployeeBenefit {
  id              String    @id @default(cuid())
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id])
  benefitId       String
  benefit         Benefit   @relation(fields: [benefitId], references: [id])
  dataInicio      DateTime
  dataFim         DateTime?
  valorMensal     Float?
  criadoEm        DateTime  @default(now())
  
  @@unique([employeeId, benefitId, dataInicio])
}

model ThirdPartyContract {
  id              String    @id @default(cuid())
  empresa         String
  cnpj            String
  contato         String?
  servico         String
  valorMensal     Float
  dataInicio      DateTime
  dataFim         DateTime?
  status          String    @default("ATIVO") // ATIVO, SUSPENSO, ENCERRADO
  observacoes     String?
  criadoEm        DateTime  @default(now())
}

model ASO {
  id              String    @id @default(cuid())
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id])
  tipo            String    // ADMISSIONAL, PERIODICO, RETORNO_FERIAS, RETORNO_AFASTAMENTO, DEMISSIONAL
  dataExame       DateTime
  dataValidade    DateTime?
  medico          String
  clinica         String?
  resultado       String    // APTO, INAPTO, APTO_COM_RESTRICOES
  restricoes      String?
  anexoUrl        String?
  criadoEm        DateTime  @default(now())
}

model ExitInterview {
  id              String    @id @default(cuid())
  employeeId      String    @unique
  employee        Employee  @relation(fields: [employeeId], references: [id])
  dataEntrevista  DateTime
  entrevistador   String
  motivoSaida     String    // VOLUNTARIO, DEMISSAO_SEM_JUSTA_CAUSA, JUSTA_CAUSA, APOSENTADORIA
  feedbackJson    String?
  notaSatisfacao  Int?
  sugestoes       String?
  voltaria        Boolean?
  criadoEm        DateTime  @default(now())
}

// ========== FASE 1: DST (SEGURANÇA DO TRABALHO) ==========

model SafetyInspection {
  id              String    @id @default(cuid())
  projectId       String?
  project         Project?  @relation(fields: [projectId], references: [id])
  inspectorId     String
  inspector       User      @relation("InspectorSafety", fields: [inspectorId], references: [id])
  dataInspecao    DateTime
  tipo            String    // ROTINA, ESPECIAL, POS_ACIDENTE
  checklistJson   String?
  conformidades   Int       @default(0)
  naoConformidades Int      @default(0)
  observacoes     String?
  status          String    @default("PENDENTE") // PENDENTE, REGULARIZADO
  criadoEm        DateTime  @default(now())
}

model Accident {
  id              String    @id @default(cuid())
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id])
  projectId       String?
  project         Project?  @relation(fields: [projectId], references: [id])
  dataOcorrencia  DateTime
  horaOcorrencia  String?
  local           String
  descricao       String
  gravidade       String    // LEVE, MODERADO, GRAVE, FATAL
  tipoAcidente    String    // TIPICO, TRAJETO, DOENCA_OCUPACIONAL
  partesCorpo     String?
  testemunhas     String?
  catEmitida      Boolean   @default(false)
  numeroCAT       String?
  dataAfastamento DateTime?
  diasAfastado    Int?
  investigacao    String?
  medidasCorretivas String?
  status          String    @default("ABERTO") // ABERTO, INVESTIGACAO, FECHADO
  criadoEm        DateTime  @default(now())
}

model EPIDistribution {
  id              String    @id @default(cuid())
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id])
  epiTipo         String    // CAPACETE, LUVAS, OCULOS, BOTINAS, CINTO, etc
  marca           String?
  quantidade      Int       @default(1)
  dataEntrega     DateTime
  dataValidade    DateTime?
  nf              String?
  assinaturaUrl   String?
  status          String    @default("EM_USO") // EM_USO, DEVOLVIDO, DANIFICADO
  observacoes     String?
  criadoEm        DateTime  @default(now())
}

// ========== FASE 1: LOGÍSTICA (Complemento - Ferramentas) ==========

model Tool {
  id              String     @id @default(cuid())
  codigo          String     @unique
  nome            String
  tipo            String
  marca           String?
  estado          String     @default("BOM") // BOM, REGULAR, DANIFICADO
  localizacao     String?
  responsavel     String?
  dataAquisicao   DateTime?
  valorAquisicao  Float?
  criadoEm        DateTime   @default(now())
  
  loans           ToolLoan[]
}

model ToolLoan {
  id              String    @id @default(cuid())
  toolId          String
  tool            Tool      @relation(fields: [toolId], references: [id])
  usuarioId       String
  usuario         User      @relation(fields: [usuarioId], references: [id])
  projectId       String?
  project         Project?  @relation(fields: [projectId], references: [id])
  dataSaida       DateTime
  dataRetorno     DateTime?
  estadoSaida     String
  estadoRetorno   String?
  observacoes     String?
  criadoEm        DateTime  @default(now())
}

model MaintenanceRecord {
  id              String    @id @default(cuid())
  vehicleId       String
  vehicle         Vehicle   @relation(fields: [vehicleId], references: [id])
  tipo            String    // PREVENTIVA, CORRETIVA, REVISAO
  descricao       String
  oficina         String?
  valor           Float?
  dataExecucao    DateTime
  quilometragem   Int?
  proximaRevisao  DateTime?
  anexoUrl        String?
  criadoEm        DateTime  @default(now())
}

// ========== FASE 2: COMERCIAL (Pipeline de Vendas) ==========

model Lead {
  id              String    @id @default(cuid())
  clientId        String
  client          Client    @relation(fields: [clientId], references: [id])
  
  nomeObra        String
  localizacao     String?
  origem          String?   // INDICACAO, SITE, REDE_SOCIAL, EVENTO, PARCERIA
  classificacao   String?   // RESIDENCIAL, COMERCIAL, INDUSTRIAL, etc
  areaEstimada    Float?
  tipoObra        String?
  
  status          String    @default("NOVO") // NOVO, EM_QUALIFICACAO, QUALIFICADO, PERDIDO, CONVERTIDO
  motivoPerda     String?
  observacoes     String?
  
  criadoEm        DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  budgets         Budget[]
}

model Budget {
  id                  String    @id @default(cuid())
  leadId              String
  lead                Lead      @relation(fields: [leadId], references: [id])
  
  escopoMacro         String    // Descrição geral do orçamento
  valorEstimado       Float
  prazoEstimadoMeses  Int?
  
  premissas           String?   // JSON ou texto
  exclusoes           String?   // JSON ou texto
  observacoesTecnicas String?
  
  status              String    @default("EM_ELABORACAO") // EM_ELABORACAO, REVISAO, APROVADO, RECUSADO
  
  criadoEm            DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  proposals           Proposal[]
}

model Proposal {
  id            String    @id @default(cuid())
  budgetId      String
  budget        Budget    @relation(fields: [budgetId], references: [id])
  
  projectId     String?   @unique
  project       Project?  @relation(fields: [projectId], references: [id])
  
  versao        Int       @default(1)
  valorFinal    Float
  prazoMeses    Int?
  
  condicoesComerciais String? // JSON ou texto
  formaPagamento      String?
  
  status        String    @default("PENDENTE") // PENDENTE, NEGOCIACAO, APROVADA, RECUSADA, CONVERTIDA
  motivoRecusa  String?
  
  dataEnvio     DateTime?
  dataAprovacao DateTime?
  
  criadoEm      DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

