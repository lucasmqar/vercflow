generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// =========================================================
// ENUMS (REMOVED FOR SQLITE COMPATIBILITY - USING STRINGS)
// =========================================================
// Roles: ADMIN, CEO, GESTOR, TRIAGISTA, OPERACIONAL, PROFISSIONAL_INTERNO, PROFISSIONAL_EXTERNO, CLIENTE_VIEW
// Departments: COMERCIAL, ENGENHARIA, APROVACOES, PLANEJAMENTO, COMPRAS, LOGISTICA, RH, DP, FINANCEIRO, DST, TI
// Status: ATIVO, INATIVO, PENDENTE, CONCLUIDO, CANCELADO

// =========================================================
// CORE USERS & AUTH
// =========================================================

model User {
  id              String           @id @default(cuid())
  nome            String
  email           String           @unique
  senhaHash       String
  role            String           @default("OPERACIONAL")
  ativo           Boolean          @default(true)
  criadoEm        DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  // Relations
  logs            AuditLog[]
  records         Record[]
  professional    Professional?
  raciAssignments RaciAssignment[]
  comments        Comment[]
  
  // Request Management
  requestsCreated Request[]        @relation("UserRequestsCreated")
  requestsManaged Request[]        @relation("UserRequestsManaged")
  
  // Record Management
  recordsAsResponsavel Record[]     @relation("ResponsavelValores")

  // Department specific
  leadsManaged    Lead[]           @relation("LeadManager")
}

// =========================================================
// 1.0 COMERCIAL (Leads, Briefings, Propostas)
// =========================================================

model Lead {
  id            String    @id @default(cuid())
  nome          String
  email         String?
  telefone      String?
  origem        String?   // Instagram, Indicação, etc.
  status        String    @default("NOVO") // NOVO, QUALIFICADO, BRIEFING, PROPOSTA, CONTRATO, PERDIDO
  
  managerId     String?
  manager       User?     @relation("LeadManager", fields: [managerId], references: [id])
  
  interacoes    Interacao[]
  proposals     Proposal[]
  
  // Connection to Core Project if converted
  convertedProjectId String?
  
  criadoEm      DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Interacao {
  id        String   @id @default(cuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id])
  tipo      String   // WHATSAPP, EMAIL, REUNIAO
  descricao String
  data      DateTime @default(now())
}

model Briefing {
  id          String   @id @default(cuid())
  projectId   String   @unique
  project     Project  @relation(fields: [projectId], references: [id])
  
  dataJson    String   // JSON com respostas do briefing
  docsUrl     String?  // Link para pasta de docs
  
  aprovado    Boolean  @default(false)
  criadoEm    DateTime @default(now())
}

model Proposal {
  id          String   @id @default(cuid())
  leadId      String?
  lead        Lead?    @relation(fields: [leadId], references: [id])
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])
  
  versao      Int      @default(1)
  valorTotal  Float
  urlPdf      String?
  status      String   @default("RASCUNHO") // RASCUNHO, ENVIADA, APROVADA, REJEITADA
  
  criadoEm    DateTime @default(now())
}

// =========================================================
// 2.0 ENGENHARIA & PROJETOS
// =========================================================

model Client {
  id        String    @id @default(cuid())
  nome      String
  documento String?
  contatos  String?
  criadoEm  DateTime  @default(now())
  projects  Project[]
  records   Record[]  
}

model Project {
  id          String        @id @default(cuid())
  nome        String
  endereco    String?
  status      String        @default("ATIVA")
  
  clientId    String
  client      Client        @relation(fields: [clientId], references: [id])
  
  // Modules
  briefing    Briefing?
  proposals   Proposal[]
  activities  Activity[]
  records     Record[]
  disciplines Discipline[]
  requests    Request[]
  
  // 3.0 Aprovações
  approvals   ApprovalProcess[]
  
  criadoEm    DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Discipline {
  id            String           @id @default(cuid())
  projectId     String
  project       Project          @relation(fields: [projectId], references: [id])
  name          String
  category      String
  subcategory   String?
  description   String?
  status        String           @default("todo")
  
  assignedToId  String?
  assignedTo    Professional?    @relation(fields: [assignedToId], references: [id])
  
  tasks         Task[]
  requests      Request[]
  
  criadoEm      DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
}

model Task {
  id           String        @id @default(cuid())
  disciplineId String
  discipline   Discipline    @relation(fields: [disciplineId], references: [id])
  title        String
  description  String?
  status       String        @default("todo")
  priority     String        @default("MEDIA")
  dueDate      DateTime?
  completedAt  DateTime?
  
  assignedToId String?
  assignedTo   Professional? @relation(fields: [assignedToId], references: [id])
  
  criadoEm     DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

// =========================================================
// 3.0 APROVAÇÕES (Legal)
// =========================================================

model ApprovalProcess {
  id          String    @id @default(cuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id])
  
  orgao       String    // PREFEITURA, CONDOMINIO, BOMBEIROS, VISA, SUDERV
  status      String    @default("PENDENTE") // PENDENTE, ANALISE, APROVADO, COM_PENDENCIA
  
  protocolo   String?
  dataEntrada DateTime?
  dataSaida   DateTime?
  
  observacoes String?
  
  criadoEm    DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// =========================================================
// 5.0 COMPRAS & FINANCEIRO
// =========================================================

model PurchaseRequest {
  id          String    @id @default(cuid())
  projectId   String?   // Opcional, pode ser estoque
  
  item        String
  quantidade  Float
  unidade     String
  
  status      String    @default("SOLICITADO") // SOLICITADO, COTACAO, COMPRADO, ENTREGUE
  
  cotacoes    Quote[]
  
  criadoEm    DateTime  @default(now())
}

model Quote {
  id                String          @id @default(cuid())
  purchaseRequestId String
  purchaseRequest   PurchaseRequest @relation(fields: [purchaseRequestId], references: [id])
  
  fornecedor        String
  valorUnitario     Float
  prazoEntrega      String?
  selecionado       Boolean         @default(false)
}

// =========================================================
// LEGACY / CORE RECORDS
// =========================================================

model Record {
  id                    String       @id @default(cuid())
  refCodigo             String       @unique @default(cuid())
  authorId              String
  projectId             String?
  clientId              String?
  texto                 String?      
  type                  String       @default("TEXTO")
  status                String       @default("REGISTRO")
  prioridade            String       @default("MEDIA")
  natureza              String?
  
  responsavelValoresId  String?
  responsavelValores    User?        @relation("ResponsavelValores", fields: [responsavelValoresId], references: [id])
  
  parentId              String?
  parent                Record?      @relation("RecordRevisions", fields: [parentId], references: [id])
  revisions             Record[]     @relation("RecordRevisions")
  
  isInicial             Boolean      @default(true)
  criadoEm              DateTime     @default(now())
  
  project               Project?     @relation(fields: [projectId], references: [id])
  client                Client?      @relation(fields: [clientId], references: [id])
  author                User         @relation(fields: [authorId], references: [id])
  
  items                 RecordItem[]
  activities            Activity[]
  documents             Document[]
  sketch                Sketch?
}

model RecordItem {
  id        String     @id @default(cuid())
  recordId  String
  record    Record     @relation(fields: [recordId], references: [id])
  type      String     @default("TEXTO")
  content   String     
  order     Int        @default(0)
  criadoEm  DateTime   @default(now())
}

model Sketch {
  id       String   @id @default(cuid())
  recordId String   @unique
  record   Record   @relation(fields: [recordId], references: [id])
  dataJson String
  imageUrl String?
  criadoEm DateTime @default(now())
}

model Document {
  id       String   @id @default(cuid())
  recordId String
  record   Record   @relation(fields: [recordId], references: [id])
  tipo     String   @default("ESBOCO_TIMBRADO")
  pdfUrl   String?
  status   String   @default("RASCUNHO")
  versao   Int      @default(1)
  hash     String?
  criadoEm DateTime @default(now())
}

// =========================================================
// SUPPORTING MODELS
// =========================================================

model Request {
  id                 String        @id @default(cuid())
  projectId          String
  project            Project       @relation(fields: [projectId], references: [id])
  disciplineId       String?
  discipline         Discipline?   @relation(fields: [disciplineId], references: [id])
  title              String
  description        String
  type               String
  status             String        @default("open")
  priority           String        @default("MEDIA")
  requestedById      String
  requestedBy        User          @relation("UserRequestsCreated", fields: [requestedById], references: [id])
  assignedToId       String?
  assignedTo         Professional? @relation(fields: [assignedToId], references: [id])
  dueDate            DateTime?
  cancellationReason String?
  cancelledById      String?
  cancelledBy        User?         @relation("UserRequestsManaged", fields: [cancelledById], references: [id])
  cancelledAt        DateTime?
  criadoEm           DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
}

model Activity {
  id          String               @id @default(cuid())
  recordId    String?
  record      Record?              @relation(fields: [recordId], references: [id])
  projectId   String
  project     Project              @relation(fields: [projectId], references: [id])
  titulo      String
  descricao   String?
  status      String               @default("PLANEJADO")
  prioridade  String               @default("MEDIA")
  dataInicio  DateTime?
  dataFim     DateTime?
  criadoEm    DateTime             @default(now())
  assignments ActivityAssignment[]
}

model Professional {
  id              String               @id @default(cuid())
  nome            String
  tipo            String               @default("EXTERNO_MAO_OBRA") 
  documento       String?
  contatos        String?
  userId          String?              @unique
  user            User?                @relation(fields: [userId], references: [id])
  assignments     ActivityAssignment[]
  disciplines     Discipline[]
  tasks           Task[]
  requestsManaged Request[]
  categories      ProfessionalCategory[]
  criadoEm        DateTime               @default(now())
}

model ProfessionalCategory {
  id             String       @id @default(cuid())
  professionalId String
  professional   Professional @relation(fields: [professionalId], references: [id])
  category       String       
  criadoEm       DateTime     @default(now())
  @@unique([professionalId, category])
}

model ActivityAssignment {
  id             String       @id @default(cuid())
  activityId     String
  activity       Activity     @relation(fields: [activityId], references: [id])
  professionalId String
  professional   Professional @relation(fields: [professionalId], references: [id])
  valorPrevisto  Float
  valorReal      Float?
  criadoEm       DateTime     @default(now())
}

model RaciAssignment {
  id         String     @id @default(cuid())
  entityType String
  entityId   String
  userId     String
  user       User       @relation(fields: [userId], references: [id])
  role       String     
  criadoEm   DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

model Comment {
  id         String     @id @default(cuid())
  entityType String
  entityId   String
  userId     String
  user       User       @relation(fields: [userId], references: [id])
  content    String
  criadoEm   DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  tipoEvento  String
  entidade    String
  entidadeId  String
  payloadJson String?
  criadoEm    DateTime @default(now())
}
